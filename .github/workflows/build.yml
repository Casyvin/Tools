name: Build Cross-Platform Packages

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'zulu'

      - name: Download JavaFX for Windows
        run: |
          $javafxVersion = "17.0.6"
          $url = "https://download2.gluonhq.com/openjfx/$javafxVersion/openjfx-${javafxVersion}_windows-x64_bin-sdk.zip"
          Invoke-WebRequest -Uri $url -OutFile "javafx-sdk.zip"
          Expand-Archive -Path "javafx-sdk.zip" -DestinationPath "javafx"
          echo "JAVAFX_HOME=$pwd\javafx\javafx-sdk-$javafxVersion" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Build with Maven
        run: mvn clean package

      - name: List generated files
        run: |
          echo "=== Files in target directory ==="
          Get-ChildItem -Path target -Recurse -Name | Where-Object { $_ -like "*.jar" }

      - name: Create Windows Package
        run: |
          # 使用包含所有依赖的JAR文件
          jpackage --name PL-TOOLS `
                   --app-version 1.0 `
                   --input target `
                   --main-jar PL-TOOLS-1.0-SNAPSHOT-with-deps.jar `
                   --main-class com.sws4cloud.pltools.PLToolsApplication `
                   --module-path "$env:JAVAFX_HOME\jmods" `
                   --add-modules javafx.controls,javafx.fxml,javafx.web,javafx.swing,javafx.media `
                   --type exe `
                   --dest release `
                   --win-menu `
                   --win-shortcut

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: PL-TOOLS-windows
          path: 'release/*.exe'

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'zulu'

      - name: Download JavaFX for macOS
        run: |
          javafxVersion="17.0.6"
          curl -L -o javafx-sdk.zip "https://download2.gluonhq.com/openjfx/$javafxVersion/openjfx-${javafxVersion}_osx-x64_bin-sdk.zip"
          unzip javafx-sdk.zip
          echo "JAVAFX_HOME=$(pwd)/javafx-sdk-$javafxVersion" >> $GITHUB_ENV

      - name: Build with Maven
        run: mvn clean package

      - name: List generated files
        run: |
          echo "=== Files in target directory ==="
          find target -name "*.jar" -type f

      - name: Create macOS Package
        run: |
          jpackage --name PL-TOOLS \
                   --app-version 1.0 \
                   --input target \
                   --main-jar PL-TOOLS-1.0-SNAPSHOT-with-deps.jar \
                   --main-class com.sws4cloud.pltools.PLToolsApplication \
                   --module-path "$JAVAFX_HOME/jmods" \
                   --add-modules javafx.controls,javafx.fxml,javafx.web,javafx.swing,javafx.media \
                   --type dmg \
                   --dest release

      - name: Upload macOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: PL-TOOLS-macos
          path: 'release/*.dmg'