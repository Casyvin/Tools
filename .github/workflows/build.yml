name: Build Cross-Platform Packages

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'zulu'

      - name: Download JavaFX for Windows
        run: |
          $javafxVersion = "17.0.6"
          $url = "https://download2.gluonhq.com/openjfx/$javafxVersion/openjfx-${javafxVersion}_windows-x64_bin-sdk.zip"
          Invoke-WebRequest -Uri $url -OutFile "javafx-sdk.zip"
          Expand-Archive -Path "javafx-sdk.zip" -DestinationPath "javafx"
          echo "JAVAFX_HOME=$pwd\javafx\javafx-sdk-$javafxVersion" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Build with Maven
        run: |
          mvn clean compile
          mvn package

      - name: Debug - List generated files
        run: |
          echo "=== Listing target directory ==="
          Get-ChildItem -Path target -Recurse -Name
          echo "=== Listing modules directory ==="
          if (Test-Path target/modules) {
            Get-ChildItem -Path target/modules -Name
          }

      - name: Create Windows Package
        run: |
          # 检查主JAR是否包含模块信息
          echo "=== Checking module info ==="
          jar --file=target/PL-TOOLS-1.0-SNAPSHOT.jar --describe-module
          
          # 构建模块路径
          $modulePath = "$env:JAVAFX_HOME\jmods;target\PL-TOOLS-1.0-SNAPSHOT.jar"
          if (Test-Path target/modules) {
            $modulePath = "$modulePath;target\modules\*.jar"
          }
          echo "Module path: $modulePath"
          
          jpackage --name PL-TOOLS `
                   --app-version 1.0 `
                   --module-path $modulePath `
                   --module com.sws4cloud.pltools/com.sws4cloud.pltools.PLToolsApplication `
                   --type exe `
                   --dest release `
                   --win-menu `
                   --win-shortcut

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: PL-TOOLS-windows
          path: 'release/*.exe'

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'zulu'

      - name: Download JavaFX for macOS
        run: |
          javafxVersion="17.0.6"
          curl -L -o javafx-sdk.zip "https://download2.gluonhq.com/openjfx/$javafxVersion/openjfx-${javafxVersion}_osx-x64_bin-sdk.zip"
          unzip javafx-sdk.zip
          echo "JAVAFX_HOME=$(pwd)/javafx-sdk-$javafxVersion" >> $GITHUB_ENV

      - name: Build with Maven
        run: |
          mvn clean compile
          mvn package

      - name: Debug - List generated files
        run: |
          echo "=== Listing target directory ==="
          find target -type f -name "*.jar" | head -20
          echo "=== Listing modules directory ==="
          if [ -d "target/modules" ]; then
            ls -la target/modules/
          fi

      - name: Create macOS Package
        run: |
          # 检查主JAR是否包含模块信息
          echo "=== Checking module info ==="
          jar --file=target/PL-TOOLS-1.0-SNAPSHOT.jar --describe-module
          
          # 构建模块路径
          modulePath="$JAVAFX_HOME/jmods:target/PL-TOOLS-1.0-SNAPSHOT.jar"
          if [ -d "target/modules" ]; then
            modulePath="$modulePath:target/modules/*"
          fi
          echo "Module path: $modulePath"
          
          jpackage --name PL-TOOLS \
                   --app-version 1.0 \
                   --module-path "$modulePath" \
                   --module com.sws4cloud.pltools/com.sws4cloud.pltools.PLToolsApplication \
                   --type dmg \
                   --dest release

      - name: Upload macOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: PL-TOOLS-macos
          path: 'release/*.dmg'